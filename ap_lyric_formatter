'''
    Atom. 02/06/26.
    A ComfyUI node that:
    - Accepts a block of text lyrics,
    - Splits lines on periods, exclamation points, or question marks,
    - Outputs a single formatted lyric string for ACE-Step 1.5.

'''

VERSION = "1.0"

class ap_AceStepLyricFormatter:
    def __init__(self):
        pass

    @classmethod
    def INPUT_TYPES(cls):
        return {
            "required": {
                "raw_lyrics": ("STRING", {"multiline": True, "default": "Enter lyrics here"}),
            }
        }

    RETURN_TYPES = ("STRING",)
    FUNCTION = "format_ace_step_lyrics"
    CATEGORY = "Text"

    def format_ace_step_lyrics(self, raw_lyrics=""):
        if not raw_lyrics:
            return ("",)

        import re
        # Split lines on ., !, or ?
        lines = re.split(r"[.!?]+", raw_lyrics.strip())
        lines = [l.strip() for l in lines if l.strip()]

        if not lines:
            return ("",)

        # Define fixed section order
        section_order = ["Intro", "Verse", "Chorus", "Verse", "Bridge", "Outro"]
        num_sections = len(section_order)
        num_lines = len(lines)

        # Determine roughly how many lines per section
        # Distribute as evenly as possible
        per_section_base = num_lines // num_sections
        remainder = num_lines % num_sections

        sections = []
        idx = 0
        for i, name in enumerate(section_order):
            # Add 1 extra line for the first 'remainder' sections
            count = per_section_base + (1 if i < remainder else 0)
            segment = lines[idx:idx+count]
            if segment:
                sections.append((name, segment))
            idx += count

        # Assemble formatted lyrics
        formatted = []
        for name, seg_lines in sections:
            formatted.append(f"[{name}]")
            formatted.extend(seg_lines)

        output = "\n".join(formatted)
        return (output,)

        
# NOTE: names should be globally unique
NODE_CLASS_MAPPINGS = {"ap_AceStepLyricFormatter": ap_AceStepLyricFormatter}

# A dictionary that contains the friendly/humanly readable titles for the nodes
NODE_DISPLAY_NAME_MAPPINGS = {"ap_AceStepLyricFormatter": "Ace Step Lyric Formatter %s" % VERSION}
